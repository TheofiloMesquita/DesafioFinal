name: CI-CD

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Construir imagem Docker
        run: |
          docker build -t myapp:latest .

      - name: Teste rápido de inicialização do container (Smoke Test)
        run: |
          docker run -d --name app_test -p 1313:1313 myapp:latest
          sleep 5
          docker logs app_test
          docker stop app_test || true
          docker rm app_test || true

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          pip install -r requirements.txt
          pip install pytest  # pytest não é obrigatório, mas é útil se você deseja rodar testes com pytest também

      - name: Rodar testes
        run: |
          python -m unittest discover -s tests

  deploy:
    name: Deploy Docker App to Vercel
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Vercel CLI
        run: npm install -g vercel

      - name: Pull Config do Vercel (importantíssimo)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=production \
            --token=$VERCEL_TOKEN \
            --scope=$VERCEL_ORG_ID

      - name: Build do Docker no Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel build \
            --token=$VERCEL_TOKEN \
            --scope=$VERCEL_ORG_ID

      - name: Deploy Docker para Produção no Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel deploy --prebuilt --prod \
            --token=$VERCEL_TOKEN \
            --scope=$VERCEL_ORG_ID